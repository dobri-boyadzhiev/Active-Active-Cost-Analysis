{% extends "base.html" %}

{% block title %}Top Savings - AA Report{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h1 class="h2 mb-2">
            <i class="bi bi-trophy"></i> Savings Opportunities
        </h1>
        <p class="text-muted mb-0" style="font-size: 0.95rem;">Clusters with highest potential cost savings</p>
    </div>
    {% if selected_run %}
    <div class="col-md-6 text-md-end">
        <div class="text-muted" style="font-size: 0.875rem;">
            <strong><i class="bi bi-bar-chart-line"></i> Latest Run:</strong>
            Run #{{ selected_run.run_id }} | {{ selected_run.run_timestamp[:10] }} {{ selected_run.run_timestamp[11:19] }}
        </div>
    </div>
    {% endif %}
</div>

<!-- Filters Panel -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-funnel-fill"></i> Filters</h5>
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="run_id" class="form-label"><i class="bi bi-calendar3"></i> Run / Date</label>
                <select name="run_id" id="run_id" class="form-select filter-select">
                    <option value="">Latest Run</option>
                    {% for run in all_runs %}
                    <option value="{{ run.run_id }}"
                            {% if selected_run and run.run_id == selected_run.run_id %}selected{% endif %}>
                        Run #{{ run.run_id }} - {{ run.run_timestamp[:10] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="cloud_provider" class="form-label"><i class="bi bi-cloud"></i> Cloud Provider</label>
                <select name="cloud_provider" id="cloud_provider" class="form-select filter-select">
                    <option value="all" {% if cloud_provider_filter == 'all' %}selected{% endif %}>All</option>
                    {% for provider in cloud_providers %}
                    <option value="{{ provider }}" {% if cloud_provider_filter == provider %}selected{% endif %}>
                        {{ provider|upper }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="software_version" class="form-label"><i class="bi bi-database"></i> Software Version</label>
                <select name="software_version" id="software_version" class="form-select filter-select">
                    <option value="all" {% if software_version_filter == 'all' %}selected{% endif %}>All Versions</option>
                    {% for version in software_versions %}
                    <option value="{{ version }}" {% if software_version_filter == version %}selected{% endif %}>
                        {{ version }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="top_n" class="form-label"><i class="bi bi-hash"></i> Top N Clusters</label>
                <select name="top_n" id="top_n" class="form-select filter-select">
                    <option value="all" {% if top_n == 'all' %}selected{% endif %}>All</option>
                    <option value="20" {% if top_n == 20 %}selected{% endif %}>20</option>
                    <option value="50" {% if top_n == 50 %}selected{% endif %}>50</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-secondary w-100" id="resetFilters">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Top Savings Table -->
{% if opportunities %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-table"></i> {{ optimizable_count }} Savings Opportunities of {{ opportunities | length }}
                    <i class="bi bi-info-circle ms-1" style="cursor: pointer; font-size: 0.9rem;"
                       data-bs-toggle="popover"
                       data-bs-trigger="hover focus"
                       data-bs-placement="bottom"
                       data-bs-html="true"
                       data-bs-content="<strong>{{ optimizable_count }}</strong> clusters with positive savings (optimization opportunities)<br><strong>{{ opportunities | length }}</strong> total clusters shown (including non-optimizable)"></i>
                </h4>
                <button type="button" class="btn btn-light btn-sm" id="exportCsvBtn" title="Export visible table data to CSV">
                    <i class="bi bi-download"></i> Export to CSV
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="savingsTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Cluster UID</th>
                                <th>Cluster Name</th>
                                <th>Region</th>
                                <th>Cloud Provider</th>
                                <th>Software Version</th>
                                <th>Cluster Age</th>
                                <th class="text-end">Current Price</th>
                                <th class="text-end">Optimal Price</th>
                                <th class="text-end">Savings</th>
                                <th class="text-end">Savings %</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cluster in opportunities %}
                            <tr{% if cluster.savings <= 0 %} class="table-secondary" style="opacity: 0.6;"{% endif %}>
                                <td><strong>{{ loop.index }}</strong></td>
                                <td><code>{{ cluster.mc_uid }}</code></td>
                                <td>
                                    {% if cluster.cluster_name %}
                                    <small>{{ cluster.cluster_name }}</small>
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cluster.region %}
                                    <small>{{ cluster.region }}</small>
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cluster.cloud_provider %}
                                    <span class="badge bg-info">{{ cluster.cloud_provider|upper }}</span>
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cluster.software_version %}
                                    <span class="badge bg-success">{{ cluster.software_version }}</span>
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                                <td data-order="{{ cluster.age_days if cluster.age_days is not none else -1 }}">
                                    {% if cluster.age_days is not none %}
                                    {% if cluster.age_days >= 365 %}
                                    <span class="badge bg-warning text-dark">{{ cluster.age_display }}</span>
                                    {% else %}
                                    <span class="badge bg-info">{{ cluster.age_display }}</span>
                                    {% endif %}
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                                <td class="text-end">${{ "{:,.2f}".format(cluster.current_price) }}</td>
                                <td class="text-end">${{ "{:,.2f}".format(cluster.optimal_price) }}</td>
                                <td class="text-end">
                                    {% if cluster.savings > 0 %}
                                    <span class="text-danger fw-bold">${{ "{:,.2f}".format(cluster.savings) }}</span>
                                    {% elif cluster.savings < 0 %}
                                    <span class="text-success fw-bold">${{ "{:,.2f}".format(cluster.savings) }}</span>
                                    {% else %}
                                    <span class="fw-bold">${{ "{:,.2f}".format(cluster.savings) }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if cluster.savings_percent > 0 %}
                                    <span class="badge bg-danger">{{ "{:.1f}".format(cluster.savings_percent) }}%</span>
                                    {% elif cluster.savings_percent < 0 %}
                                    <span class="badge bg-success">{{ "{:.1f}".format(cluster.savings_percent) }}%</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ "{:.1f}".format(cluster.savings_percent) }}%</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('cluster_details', mc_uid=cluster.mc_uid) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-warning fw-bold">
                                <td colspan="7">
                                    TOTAL
                                    <i class="bi bi-info-circle ms-1" style="cursor: pointer;"
                                       data-bs-toggle="popover"
                                       data-bs-trigger="hover focus"
                                       data-bs-placement="top"
                                       data-bs-html="true"
                                       data-bs-content="<strong>Total Calculation:</strong><br>Sums <strong>only clusters with positive savings</strong> (optimization opportunities).<br><br><strong>Note:</strong> Clusters with negative or zero savings are shown in the table but excluded from the total, as they don't represent optimization opportunities."></i>
                                </td>
                                <td class="text-end">${{ "{:,.2f}".format(opportunities | sum(attribute='current_price')) }}</td>
                                <td class="text-end">${{ "{:,.2f}".format(opportunities | sum(attribute='optimal_price')) }}</td>
                                <td class="text-end">
                                    {% set total_savings = opportunities | selectattr('savings', 'gt', 0) | sum(attribute='savings') %}
                                    <span class="text-danger">${{ "{:,.2f}".format(total_savings) }}</span>
                                </td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Savings Chart -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-bar-chart"></i> Savings Visualization</h4>
            </div>
            <div class="card-body">
                <canvas id="savingsChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    No savings data available for the selected run.
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if opportunities %}
<script>
$(document).ready(function() {
    $('#savingsTable').DataTable({
        paging: false,
        searching: false,
        info: false,
        order: [[9, 'desc']]  // Sort by Savings column (highest first)
    });
});

// Savings Bar Chart
const savingsData = {{ opportunities | tojson }};

const ctx = document.getElementById('savingsChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: savingsData.map(d => d.mc_uid),
        datasets: [
            {
                label: 'Current Price',
                data: savingsData.map(d => d.current_price),
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                borderColor: 'rgb(220, 53, 69)',
                borderWidth: 1
            },
            {
                label: 'Optimal Price',
                data: savingsData.map(d => d.optimal_price),
                backgroundColor: 'rgba(25, 135, 84, 0.7)',
                borderColor: 'rgb(25, 135, 84)',
                borderWidth: 1
            },
            {
                label: 'Savings',
                data: savingsData.map(d => d.savings),
                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                borderColor: 'rgb(255, 193, 7)',
                borderWidth: 1
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'top',
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        return label;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            },
            x: {
                ticks: {
                    maxRotation: 45,
                    minRotation: 45
                }
            }
        }
    }
});

// Reset Filters button
document.getElementById('resetFilters').addEventListener('click', function() {
    window.location.href = buildUrl('top-savings');
});

// Auto-apply filters on change
const filterSelects = document.querySelectorAll('.filter-select');

// Function to apply filters by reloading the page with new parameters
function applyFilters() {
    const runId = document.getElementById('run_id').value;
    const cloudProvider = document.getElementById('cloud_provider').value;
    const softwareVersion = document.getElementById('software_version').value;
    const topN = document.getElementById('top_n').value;

    // Build URL with parameters
    const params = new URLSearchParams();
    if (runId) params.append('run_id', runId);
    if (cloudProvider !== 'all') params.append('cloud_provider', cloudProvider);
    if (softwareVersion !== 'all') params.append('software_version', softwareVersion);
    if (topN !== 'all') params.append('top_n', topN);

    // Reload page with new filters
    window.location.href = buildUrl('top-savings') + '?' + params.toString();
}

// Add event listeners to all filter selects for auto-apply
filterSelects.forEach(select => {
    select.addEventListener('change', applyFilters);
});

// Export to CSV functionality
document.getElementById('exportCsvBtn').addEventListener('click', function() {
    exportTableToCSV('savingsTable', 'top_savings_opportunities.csv');
});

// Export table to CSV function
function exportTableToCSV(tableId, filename) {
    const table = document.getElementById(tableId);
    if (!table) {
        alert('Table not found');
        return;
    }

    const csv = [];

    // Get visible rows from DataTable
    const dataTable = $('#' + tableId).DataTable();
    const visibleRows = dataTable.rows({ search: 'applied' }).nodes().toArray();

    // Add header row
    const headerRow = [];
    const headers = table.querySelectorAll('thead th');
    headers.forEach((header, index) => {
        const headerText = header.textContent.trim();
        // Skip the Actions column
        if (headerText !== 'Actions') {
            headerRow.push('"' + headerText.replace(/"/g, '""') + '"');
        }
    });
    csv.push(headerRow.join(','));

    // Add data rows (only visible ones)
    visibleRows.forEach(row => {
        const dataRow = [];
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
            // Skip the Actions column (last column)
            if (index < cells.length - 1) {
                let cellText = cell.textContent.trim();
                // Clean up the text (remove extra spaces, newlines)
                cellText = cellText.replace(/\s+/g, ' ');
                dataRow.push('"' + cellText.replace(/"/g, '""') + '"');
            }
        });
        csv.push(dataRow.join(','));
    });

    // Add footer row (totals)
    const footerRow = table.querySelector('tfoot tr');
    if (footerRow) {
        const totalRow = [];
        const footerCells = footerRow.querySelectorAll('td');
        footerCells.forEach((cell, index) => {
            let cellText = cell.textContent.trim();
            cellText = cellText.replace(/\s+/g, ' ');
            totalRow.push('"' + cellText.replace(/"/g, '""') + '"');
        });
        csv.push(totalRow.join(','));
    }

    // Create and download CSV file
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Show success message if available
    if (typeof window.AADashboard !== 'undefined' && window.AADashboard.showToast) {
        window.AADashboard.showToast('CSV exported successfully!', 'success');
    }
}

</script>
{% endif %}
{% endblock %}
