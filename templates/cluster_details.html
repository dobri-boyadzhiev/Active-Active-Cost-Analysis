{% extends "base.html" %}

{% block title %}Cluster {{ mc_uid }} - AA Report{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('top_savings') }}">Savings</a></li>
                <li class="breadcrumb-item active">Cluster: {{ mc_uid }}</li>
            </ol>
        </nav>
        <h1 class="h2 mb-2">
            <i class="bi bi-server"></i> Cluster: <code>{{ mc_uid }}</code>
        </h1>
        <p class="text-muted mb-0" style="font-size: 0.95rem;">
            Latest data from: {{ latest_result.run_timestamp[:10] }}
        </p>
    </div>
</div>

<!-- Quick Stats Badges -->
{% if metadata %}
<div class="row mb-3">
    <div class="col">
        <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-warning text-dark p-2">
                <i class="bi bi-cloud"></i> {{ metadata.cloud_provider }}
            </span>
            <span class="badge bg-info p-2">
                <i class="bi bi-geo-alt"></i> {{ metadata.region }}
            </span>
            <span class="badge bg-success p-2">
                <i class="bi bi-database"></i> {{ metadata.software_version or metadata.redis_version }}
            </span>
            {% if metadata.multi_az %}
            <span class="badge bg-danger p-2">
                <i class="bi bi-shield-check"></i> Multi-AZ
            </span>
            {% endif %}
            <span class="badge bg-primary p-2">
                <i class="bi bi-hdd"></i> {{ total_current_instances }} Instances
            </span>
            {% if metadata.total_nodes_count %}
            <span class="badge bg-primary p-2">
                <i class="bi bi-server"></i> {{ metadata.total_nodes_count }} Nodes
            </span>
            {% endif %}
            {% if metadata.shards_count %}
            <span class="badge bg-secondary p-2">
                <i class="bi bi-diagram-3"></i> {{ metadata.shards_count }} Shards
            </span>
            {% endif %}
            {% if metadata.total_storage_gb %}
            <span class="badge bg-secondary p-2">
                <i class="bi bi-hdd-stack"></i> {{ metadata.total_storage_gb }} GB
            </span>
            {% endif %}
            {% if metadata.creation_date %}
            <span class="badge bg-dark p-2">
                <i class="bi bi-calendar"></i> Created {{ metadata.creation_date }}
            </span>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Enhanced Savings Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h5><i class="bi bi-piggy-bank"></i> Monthly Savings</h5>
                <h2><strong>${{ "{:,.2f}".format(latest_result.total_savings | adjusted) }}</strong></h2>
                <p class="mb-0">
                    {{ "{:.1f}".format(latest_result.savings_percent) }}% reduction
                    <br><small>RCP Blueprint: ${{ "{:,.2f}".format(latest_result.total_savings) }}</small>
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h5><i class="bi bi-calendar-check"></i> Annual Savings</h5>
                <h2><strong>${{ "{:,.2f}".format((latest_result.total_savings * 12) | adjusted) }}</strong></h2>
                <p class="mb-0">
                    Projected yearly impact
                    <br><small>RCP Blueprint: ${{ "{:,.2f}".format(latest_result.total_savings * 12) }}</small>
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h5><i class="bi bi-graph-up"></i> ROI Timeline</h5>
                <h2><strong>Immediate</strong></h2>
                <p class="mb-0">No migration cost</p>
            </div>
        </div>
    </div>
</div>

<!-- Cluster Metadata -->
{% if metadata %}
<div class="row mb-4">
    <div class="col">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="bi bi-info-circle"></i> Cluster Information</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <table class="table table-sm">
                            <tr>
                                <th width="50%">Cluster Name:</th>
                                <td><code>{{ metadata.cluster_name or 'N/A' }}</code></td>
                            </tr>
                            <tr>
                                <th>Cloud Provider:</th>
                                <td>
                                    <span class="badge bg-primary">{{ metadata.cloud_provider or 'N/A' }}</span>
                                </td>
                            </tr>
                            <tr>
                                <th>Region:</th>
                                <td><code>{{ metadata.region or 'N/A' }}</code></td>
                            </tr>
                            <tr>
                                <th>Software Version:</th>
                                <td><span class="badge bg-success">{{ metadata.software_version or metadata.redis_version or 'N/A' }}</span></td>
                            </tr>
                            <tr>
                                <th>OS Version:</th>
                                <td>
                                    {% if metadata.os_version %}
                                    <span class="badge bg-info">Ubuntu {{ metadata.os_version }}</span>
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Cluster Age:</th>
                                <td>
                                    {% if metadata.age_days is not none %}
                                    {% if metadata.age_days >= 365 %}
                                    <span class="badge bg-warning text-dark">{{ metadata.age_display }}</span>
                                    {% else %}
                                    <span class="badge bg-info">{{ metadata.age_display }}</span>
                                    {% endif %}
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <table class="table table-sm">
                            <tr>
                                <th width="50%">Multi-AZ:</th>
                                <td>
                                    {% if metadata.multi_az %}
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Enabled</span>
                                    {% else %}
                                        <span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Disabled</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Availability Zones:</th>
                                <td><small>{{ metadata.availability_zones or 'N/A' }}</small></td>
                            </tr>
                            <tr>
                                <th>Storage Type:</th>
                                <td><code>{{ metadata.storage_type or 'N/A' }}</code></td>
                            </tr>
                            <tr>
                                <th>Total Storage:</th>
                                <td>
                                    {% if metadata.total_storage_gb %}
                                    <strong>{{ metadata.total_storage_gb }} GB</strong>
                                    {% if metadata.total_storage_gb >= 1000 %}
                                    <small class="text-muted">({{ "%.2f"|format(metadata.total_storage_gb / 1024) }} TB)</small>
                                    {% endif %}
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <table class="table table-sm">
                            <tr>
                                <th width="50%">Creation Date:</th>
                                <td>
                                    {% if metadata.creation_date %}
                                    <strong>{{ metadata.creation_date }}</strong>
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Shards:</th>
                                <td>
                                    {% if metadata.shards_count and metadata.max_shards_count %}
                                    <strong>{{ metadata.shards_count }}</strong> / {{ metadata.max_shards_count }}
                                    {% set utilization = (metadata.shards_count / metadata.max_shards_count * 100) | round(1) %}
                                    <small class="text-muted">({{ utilization }}%)</small>
                                    {% elif metadata.shards_count %}
                                    <strong>{{ metadata.shards_count }}</strong>
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Total Nodes:</th>
                                <td>
                                    {% if metadata.total_nodes_count %}
                                    <strong>{{ metadata.total_nodes_count }}</strong>
                                    {% if metadata.data_nodes_count is not none and metadata.quorum_nodes_count is not none %}
                                    <small class="text-muted">({{ metadata.data_nodes_count }} data + {{ metadata.quorum_nodes_count }} quorum)</small>
                                    {% endif %}
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Current vs Optimal Comparison -->
<div class="row mb-4">
    <!-- Current Configuration -->
    <div class="col-md-6">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h4 class="mb-0"><i class="bi bi-box"></i> Current Configuration</h4>
            </div>
            <div class="card-body">
                {% for cluster in current_clusters %}
                <h5 class="text-muted">Cluster: <code>{{ cluster.uid }}</code></h5>
                
                <h6 class="mt-3">Infrastructure:</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Instance Type</th>
                            <th class="text-end">Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for instance_type, count in cluster.infra.items() %}
                        <tr>
                            <td><code>{{ instance_type }}</code></td>
                            <td class="text-end">{{ count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <h6 class="mt-3">Pricing:</h6>
                <table class="table table-sm">
                    <tr>
                        <td>Instance Cost:</td>
                        <td class="text-end">
                            <strong>${{ "{:,.2f}".format(cluster.instance_price | adjusted) }}</strong>
                            <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(cluster.instance_price) }}</small>
                        </td>
                    </tr>
                    <tr>
                        <td>Storage Cost:</td>
                        <td class="text-end">
                            <strong>${{ "{:,.2f}".format(cluster.storage_price | adjusted) }}</strong>
                            <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(cluster.storage_price) }}</small>
                        </td>
                    </tr>
                    <tr class="fw-bold">
                        <td>Total:</td>
                        <td class="text-end text-danger">
                            <strong>${{ "{:,.2f}".format(cluster.total_price | adjusted) }}</strong>
                            <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(cluster.total_price) }}</small>
                        </td>
                    </tr>
                </table>

                {% if not loop.last %}<hr>{% endif %}
                {% endfor %}

                <!-- Total for all current clusters -->
                {% set total_current = current_clusters | sum(attribute='total_price') %}
                <div class="alert alert-danger mt-3">
                    <strong>Total Current Cost: ${{ "{:,.2f}".format(total_current | adjusted) }}</strong>
                    <br><small class="text-muted">RCP Blueprint: ${{ "{:,.2f}".format(total_current) }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Optimal Configuration -->
    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="bi bi-box-seam"></i> Optimal Configuration</h4>
            </div>
            <div class="card-body">
                {% for cluster in optimal_clusters %}
                <h5 class="text-muted">Cluster: <code>{{ cluster.uid }}</code></h5>
                
                <h6 class="mt-3">Infrastructure:</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Instance Type</th>
                            <th class="text-end">Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for instance_type, count in cluster.infra.items() %}
                        <tr>
                            <td><code>{{ instance_type }}</code></td>
                            <td class="text-end">{{ count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <h6 class="mt-3">Pricing:</h6>
                <table class="table table-sm">
                    <tr>
                        <td>Instance Cost:</td>
                        <td class="text-end">
                            <strong>${{ "{:,.2f}".format(cluster.instance_price | adjusted) }}</strong>
                            <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(cluster.instance_price) }}</small>
                        </td>
                    </tr>
                    <tr>
                        <td>Storage Cost:</td>
                        <td class="text-end">
                            <strong>${{ "{:,.2f}".format(cluster.storage_price | adjusted) }}</strong>
                            <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(cluster.storage_price) }}</small>
                        </td>
                    </tr>
                    <tr class="fw-bold">
                        <td>Total:</td>
                        <td class="text-end text-success">
                            <strong>${{ "{:,.2f}".format(cluster.total_price | adjusted) }}</strong>
                            <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(cluster.total_price) }}</small>
                        </td>
                    </tr>
                </table>

                {% if not loop.last %}<hr>{% endif %}
                {% endfor %}

                <!-- Total for all optimal clusters -->
                {% set total_optimal = optimal_clusters | sum(attribute='total_price') %}
                <div class="alert alert-success mt-3">
                    <strong>Total Optimal Cost: ${{ "{:,.2f}".format(total_optimal | adjusted) }}</strong>
                    <br><small class="text-muted">RCP Blueprint: ${{ "{:,.2f}".format(total_optimal) }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Instance Type Comparison -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary">
                <h4 class="mb-0"><i class="bi bi-cpu"></i> Instance Type Changes</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Single Cluster</th>
                                <th>Current Instance</th>
                                <th>Count</th>
                                <th class="text-center">→</th>
                                <th>Optimal Instance</th>
                                <th>Count</th>
                                <th class="text-end">Savings</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for current in current_clusters %}
                            {% set optimal = optimal_clusters[loop.index0] %}
                            <tr>
                                <td><code>{{ current.uid }}</code></td>
                                <td>
                                    {% for instance_type, count in current.infra.items() %}
                                    <code>{{ instance_type }}</code>{% if not loop.last %}<br>{% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for instance_type, count in current.infra.items() %}
                                    {{ count }}{% if not loop.last %}<br>{% endif %}
                                    {% endfor %}
                                </td>
                                <td class="text-center"><i class="bi bi-arrow-right text-primary"></i></td>
                                <td>
                                    {% for instance_type, count in optimal.infra.items() %}
                                    <code>{{ instance_type }}</code>{% if not loop.last %}<br>{% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for instance_type, count in optimal.infra.items() %}
                                    {{ count }}{% if not loop.last %}<br>{% endif %}
                                    {% endfor %}
                                </td>
                                <td class="text-end">
                                    {% set cluster_savings = current.total_price - optimal.total_price %}
                                    {% if cluster_savings > 0 %}
                                    <span class="badge bg-danger">
                                        ${{ "{:,.2f}".format(cluster_savings | adjusted) }}
                                    </span>
                                    <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(cluster_savings) }}</small>
                                    {% elif cluster_savings < 0 %}
                                    <span class="badge bg-success">
                                        ${{ "{:,.2f}".format(cluster_savings | adjusted) }}
                                    </span>
                                    <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(cluster_savings) }}</small>
                                    {% else %}
                                    <span class="badge bg-secondary">
                                        ${{ "{:,.2f}".format(cluster_savings | adjusted) }}
                                    </span>
                                    <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(cluster_savings) }}</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optimization Recommendations -->
<div class="row mb-4">
    <div class="col">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="bi bi-lightbulb"></i> Optimization Recommendations</h4>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% if latest_result.savings_percent > 30 %}
                    <li class="list-group-item">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <strong>High Savings Potential:</strong> This cluster can save over 30% - consider prioritizing optimization.
                    </li>
                    {% endif %}

                    {% if latest_result.savings_percent > 20 and latest_result.savings_percent <= 30 %}
                    <li class="list-group-item">
                        <i class="bi bi-info-circle text-info"></i>
                        <strong>Moderate Savings:</strong> This cluster has good optimization potential ({{ "{:.1f}".format(latest_result.savings_percent) }}%).
                    </li>
                    {% endif %}

                    {% if storage_savings > 0 %}
                    <li class="list-group-item">
                        <i class="bi bi-hdd text-success"></i>
                        <strong>Storage Optimization:</strong> Potential storage savings of ${{ "{:,.2f}".format(storage_savings) }}/month.
                    </li>
                    {% endif %}

                    {% if instance_savings > 0 %}
                    <li class="list-group-item">
                        <i class="bi bi-cpu text-primary"></i>
                        <strong>Instance Optimization:</strong> Potential instance savings of ${{ "{:,.2f}".format(instance_savings) }}/month.
                    </li>
                    {% endif %}

                    <li class="list-group-item">
                        <i class="bi bi-calendar-check text-info"></i>
                        <strong>Annual Impact:</strong> Implementing these changes would save ${{ "{:,.2f}".format(latest_result.total_savings * 12) }} per year.
                    </li>

                    {% if total_current_instances != total_optimal_instances %}
                    <li class="list-group-item">
                        <i class="bi bi-arrow-down-up text-warning"></i>
                        <strong>Instance Count Change:</strong> {{ total_current_instances }} → {{ total_optimal_instances }} instances
                        ({{ "+" if total_optimal_instances > total_current_instances else "" }}{{ total_optimal_instances - total_current_instances }})
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Historical Trend -->
{% if history %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-graph-up"></i> Historical Savings Trend</h4>
            </div>
            <div class="card-body">
                <canvas id="historyChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- History Table -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary">
                <h4 class="mb-0"><i class="bi bi-clock-history"></i> Historical Data</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th class="text-end">Current Price</th>
                                <th class="text-end">Optimal Price</th>
                                <th class="text-end">Savings</th>
                                <th class="text-end">Savings %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in history | reverse %}
                            <tr>
                                <td>{{ record.timestamp[:10] }}</td>
                                <td class="text-end">
                                    <strong>${{ "{:,.2f}".format(record.current_price | adjusted) }}</strong>
                                    <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(record.current_price) }}</small>
                                </td>
                                <td class="text-end">
                                    <strong>${{ "{:,.2f}".format(record.optimal_price | adjusted) }}</strong>
                                    <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(record.optimal_price) }}</small>
                                </td>
                                <td class="text-end">
                                    {% if record.savings > 0 %}
                                    <span class="text-danger fw-bold">${{ "{:,.2f}".format(record.savings | adjusted) }}</span>
                                    {% elif record.savings < 0 %}
                                    <span class="text-success fw-bold">${{ "{:,.2f}".format(record.savings | adjusted) }}</span>
                                    {% else %}
                                    <span class="fw-bold">${{ "{:,.2f}".format(record.savings | adjusted) }}</span>
                                    {% endif %}
                                    <br><small class="text-muted">RCP: ${{ "{:,.2f}".format(record.savings) }}</small>
                                </td>
                                <td class="text-end">
                                    {% if record.savings_percent > 0 %}
                                    <span class="badge bg-danger">{{ "{:.1f}".format(record.savings_percent) }}%</span>
                                    {% elif record.savings_percent < 0 %}
                                    <span class="badge bg-success">{{ "{:.1f}".format(record.savings_percent) }}%</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ "{:.1f}".format(record.savings_percent) }}%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if history %}
<script>
// Historical Trend Chart
const historyData = {{ history | tojson }};

const ctx = document.getElementById('historyChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: historyData.map(d => d.timestamp.substring(0, 10)),
        datasets: [
            {
                label: 'Current Price',
                data: historyData.map(d => d.current_price),
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.1
            },
            {
                label: 'Optimal Price',
                data: historyData.map(d => d.optimal_price),
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.1
            },
            {
                label: 'Savings',
                data: historyData.map(d => d.savings),
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.3)',
                tension: 0.1,
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'top',
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        return label;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

// Cost Breakdown Pie Charts
const currentClusters = {{ current_clusters | tojson }};
const optimalClusters = {{ optimal_clusters | tojson }};


</script>
{% endif %}
{% endblock %}

